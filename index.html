<!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Reset Password - Gym Assistance</title>
      <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
      <style>
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              margin: 0;
              padding: 20px;
              background: linear-gradient(135deg, #00D4FF 0%, #0099CC 100%);
              min-height: 100vh;
              display: flex;
              align-items: center;
              justify-content: center;
          }

          .container {
              background: white;
              padding: 2rem;
              border-radius: 16px;
              box-shadow: 0 20px 40px rgba(0,0,0,0.1);
              width: 100%;
              max-width: 400px;
          }

          .logo {
              text-align: center;
              margin-bottom: 2rem;
          }

          .logo h1 {
              color: #00D4FF;
              font-size: 28px;
              font-weight: bold;
              margin: 0;
              margin-bottom: 0.5rem;
          }

          .logo p {
              color: #666;
              margin: 0;
              font-size: 16px;
          }

          .form-group {
              margin-bottom: 1.5rem;
          }

          label {
              display: block;
              margin-bottom: 0.5rem;
              color: #333;
              font-weight: 600;
              font-size: 14px;
          }

          input[type="password"] {
              width: 100%;
              padding: 12px;
              border: 2px solid #e1e5e9;
              border-radius: 8px;
              font-size: 16px;
              box-sizing: border-box;
              transition: border-color 0.2s;
          }

          input[type="password"]:focus {
              outline: none;
              border-color: #00D4FF;
          }

          .btn {
              width: 100%;
              padding: 12px;
              background: #00D4FF;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              transition: background 0.2s;
          }

          .btn:hover {
              background: #00B8E6;
          }

          .btn:disabled {
              background: #ccc;
              cursor: not-allowed;
          }

          .message {
              padding: 12px;
              border-radius: 8px;
              margin-bottom: 1rem;
              text-align: center;
          }

          .success {
              background: #d4edda;
              color: #155724;
              border: 1px solid #c3e6cb;
          }

          .error {
              background: #f8d7da;
              color: #721c24;
              border: 1px solid #f5c6cb;
          }

          .info {
              background: #d1ecf1;
              color: #0c5460;
              border: 1px solid #bee5eb;
          }

          .app-link {
              text-align: center;
              margin-top: 1rem;
              padding-top: 1rem;
              border-top: 1px solid #e1e5e9;
          }

          .app-link a {
              color: #00D4FF;
              text-decoration: none;
              font-weight: 600;
          }

          .password-requirements {
              font-size: 12px;
              color: #666;
              margin-top: 0.5rem;
          }

          .password-requirements ul {
              margin: 0.5rem 0;
              padding-left: 1rem;
          }

          .debug {
              font-size: 12px;
              color: #666;
              margin-top: 1rem;
              padding: 10px;
              background: #f8f9fa;
              border-radius: 4px;
              word-break: break-all;
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="logo">
              <h1>üèãÔ∏è Gym Assistance</h1>
              <p>Reset Your Password</p>
          </div>

          <div id="sessionInfo"></div>

          <div id="resetForm">
              <form id="passwordResetForm">
                  <div class="form-group">
                      <label for="newPassword">New Password</label>
                      <input type="password" id="newPassword" required minlength="8"
                             placeholder="Enter your new password">
                      <div class="password-requirements">
                          <strong>Password requirements:</strong>
                          <ul>
                              <li>At least 8 characters long</li>
                              <li>Contains both letters and numbers</li>
                          </ul>
                      </div>
                  </div>

                  <div class="form-group">
                      <label for="confirmPassword">Confirm Password</label>
                      <input type="password" id="confirmPassword" required minlength="8"
                             placeholder="Confirm your new password">
                  </div>

                  <button type="submit" class="btn" id="submitBtn">Update Password</button>
              </form>
          </div>

          <div id="message"></div>
          <div id="debug" class="debug"></div>

          <div class="app-link">
              <p><a href="gymassistance://app">Open Gym Assistance App</a></p>
          </div>
      </div>

      <script>
          const supabaseUrl = 'https://mmuwsslkdfxkpcvpbxxh.supabase.co'
          const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6    
  Im1tdXdzc2xrZGZ4a3BjdnBieHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE4NzY0NTYsImV4cCI6MjA0NzQ1MjQ1Nn0.QG    
  nH9JJMnTHh7Laq8CKRnhY_L-6FEOxjFq9jmKp0p_Y'

          const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
              auth: {
                  detectSessionInUrl: true,
                  persistSession: true
              }
          })

          const resetForm = document.getElementById('resetForm')
          const messageDiv = document.getElementById('message')
          const sessionInfoDiv = document.getElementById('sessionInfo')
          const debugDiv = document.getElementById('debug')
          const form = document.getElementById('passwordResetForm')
          const submitBtn = document.getElementById('submitBtn')

          function showMessage(text, type = 'error') {
              messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`
          }

          function showDebug(text) {
              debugDiv.innerHTML = text
          }

          // Check session on load
          window.addEventListener('load', async () => {
              try {
                  // Check URL for fragments
                  const url = window.location.href
                  const hasFragment = url.includes('#')
                  showDebug(`URL: ${url}<br>Has fragment: ${hasFragment}`)

                  // Wait for Supabase to process URL
                  await new Promise(resolve => setTimeout(resolve, 1000))

                  const { data: { session }, error } = await supabase.auth.getSession()

                  if (session) {
                      sessionInfoDiv.innerHTML = '<div class="message info">‚úÖ Valid reset session      
  detected</div>'
                      showDebug(`Session found: User ${session.user.email}`)
                  } else {
                      sessionInfoDiv.innerHTML = '<div class="message error">‚ùå No valid session        
  found</div>'
                      showDebug(`No session. Error: ${error?.message || 'none'}`)
                  }

              } catch (err) {
                  showDebug(`Error: ${err.message}`)
              }
          })

          form.addEventListener('submit', async (e) => {
              e.preventDefault()

              const newPassword = document.getElementById('newPassword').value
              const confirmPassword = document.getElementById('confirmPassword').value

              if (newPassword !== confirmPassword) {
                  showMessage('Passwords do not match')
                  return
              }

              if (newPassword.length < 8) {
                  showMessage('Password must be at least 8 characters long')
                  return
              }

              if (!/[a-zA-Z]/.test(newPassword) || !/\d/.test(newPassword)) {
                  showMessage('Password must contain at least one letter and one number')
                  return
              }

              submitBtn.disabled = true
              submitBtn.textContent = 'Updating...'

              try {
                  // Check session before attempting update
                  const { data: { session } } = await supabase.auth.getSession()

                  if (!session) {
                      showMessage('No valid session. Please use a fresh reset link from your
  email.')
                      showDebug('No session found during password update')
                      return
                  }

                  showDebug(`Attempting password update for user: ${session.user.email}`)

                  const { data, error } = await supabase.auth.updateUser({
                      password: newPassword
                  })

                  if (error) {
                      showMessage(`Error: ${error.message}`)
                      showDebug(`Update error: ${error.message}`)
                  } else {
                      showMessage('Password updated successfully! üéâ You can now sign in to the Gym     
  Assistance app with your new password.', 'success')
                      showDebug('Password update successful')
                      form.style.display = 'none'
                  }
              } catch (err) {
                  showMessage('Something went wrong. Please request a new password reset from the       
  app.')
                  showDebug(`Unexpected error: ${err.message}`)
              } finally {
                  submitBtn.disabled = false
                  submitBtn.textContent = 'Update Password'
              }
          })
      </script>
  </body>
  </html>
